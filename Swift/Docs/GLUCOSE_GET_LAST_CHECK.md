# ÔøΩÔøΩ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: glucoseGetLast MODULE

**–î–∞—Ç–∞**: 2025-10-07 12:24  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ù–û  
**–°—Ç–∞—Ç—É—Å**: üî¥ **–°–ï–†–¨–ï–ó–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´!**

---

## üìã –°–†–ê–í–ù–ï–ù–ò–ï: lib/glucose-get-last.js vs SwiftOpenAPSCoordinator.swift

**JS**: lib/glucose-get-last.js (92 —Å—Ç—Ä–æ–∫–∏)  
**Swift**: SwiftOpenAPSCoordinator.swift::createGlucoseStatus() (—Å—Ç—Ä–æ–∫–∏ 487-537)

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –†–ê–ó–õ–ò–ß–ò–Ø!

### 1. –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã

**JS (lines 47-62)**:
```javascript
// Averaging within 2.5 minutes
if (-2 < minutesago && minutesago < 2.5) {
    now.glucose = ( now.glucose + then.glucose ) / 2;
    now_date = ( now_date + then_date ) / 2;
}
// short_deltas: 5-15 minutes ago (2.5 < minutesago < 17.5)
else if (2.5 < minutesago && minutesago < 17.5) {
    short_deltas.push(avgdelta);
    // last_deltas: 5-7.5 minutes ago
    if (2.5 < minutesago && minutesago < 7.5) {
        last_deltas.push(avgdelta);
    }
}
// long_deltas: 20-40 minutes ago (17.5 < minutesago < 42.5)
else if (17.5 < minutesago && minutesago < 42.5) {
    long_deltas.push(avgdelta);
}
```

**Swift (lines 496-527)**:
```swift
let current = sortedGlucose[0]
let prev1 = sortedGlucose[1]
let prev2 = sortedGlucose[2]

let delta = Double(currentBG - prev1BG)
let shortAvgDelta = (Double(currentBG - prev1BG) + Double(prev1BG - prev2BG)) / 2.0

if glucoseData.count >= 5 {
    let prev3BG = sortedGlucose[3].glucose ?? currentBG
    let prev4BG = sortedGlucose[4].glucose ?? currentBG
    longAvgDelta = (Double(currentBG - prev1BG) + Double(prev1BG - prev2BG) + 
                    Double(prev2BG - prev3BG) + Double(prev3BG - prev4BG)) / 4.0
}
```

**–ü–†–û–ë–õ–ï–ú–ê**: ‚ùå **Swift –ù–ï —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã!**
- JS: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–º–µ–Ω–Ω–æ –∑–∞ –Ω—É–∂–Ω—ã–µ –º–∏–Ω—É—Ç—ã
- Swift: –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–æ—á–∫–∏ –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏!

---

### 2. –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –±–ª–∏–∑–∫–∏—Ö —Ç–æ—á–µ–∫ (averaging within 2.5 min)

**JS (lines 47-50)**:
```javascript
// use the average of all data points in the last 2.5m for all further "now" calculations
if (-2 < minutesago && minutesago < 2.5) {
    now.glucose = ( now.glucose + then.glucose ) / 2;
    now_date = ( now_date + then_date ) / 2;
}
```

**Swift**: ‚ùå **–û–¢–°–£–¢–°–¢–í–£–ï–¢!**

**–ü–†–û–ë–õ–ï–ú–ê**: üî¥ **–ö—Ä–∏—Ç–∏—á–Ω–æ!** JS —É—Å—Ä–µ–¥–Ω—è–µ—Ç –±–ª–∏–∑–∫–∏–µ —Ç–æ—á–∫–∏ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ "now", Swift - –Ω–µ—Ç!

---

### 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ device

**JS (line 32)**:
```javascript
// only use data from the same device as the most recent BG data point
if (typeof data[i] !== 'undefined' && data[i].glucose > 38 && data[i].device === now.device) {
```

**Swift**: ‚ùå **–û–¢–°–£–¢–°–¢–í–£–ï–¢!**

**–ü–†–û–ë–õ–ï–ú–ê**: ‚ö†Ô∏è Swift –ù–ï —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ device! –ú–æ–∂–µ—Ç —Å–º–µ—à–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤!

---

### 4. Calibration records

**JS (lines 27-30)**:
```javascript
// if we come across a cal record, don't process any older SGVs
if (typeof data[i] !== 'undefined' && data[i].type === "cal") {
    last_cal = i;
    break;
}
```

**Swift**: ‚ùå **–û–¢–°–£–¢–°–¢–í–£–ï–¢!**

**–ü–†–û–ë–õ–ï–ú–ê**: ‚ö†Ô∏è Swift –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç calibration records!

---

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ glucose > 38

**JS (line 32)**:
```javascript
data[i].glucose > 38
```

**Swift**: ‚ùå **–û–¢–°–£–¢–°–¢–í–£–ï–¢!**

**–ü–†–û–ë–õ–ï–ú–ê**: ‚ö†Ô∏è Swift –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≥–ª—é–∫–æ–∑—ã!

---

### 6. –†–∞—Å—á–µ—Ç avgdelta –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏

**JS (lines 38-41)**:
```javascript
minutesago = Math.round( (now_date - then_date) / (1000 * 60) );
// multiply by 5 to get the same units as delta, i.e. mg/dL/5m
change = now.glucose - then.glucose;
avgdelta = change/minutesago * 5;
```

**Swift**: ‚ùå **–û–¢–°–£–¢–°–¢–í–£–ï–¢!**

**–ü–†–û–ë–õ–ï–ú–ê**: üî¥ **–ö—Ä–∏—Ç–∏—á–Ω–æ!** JS –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç delta –∫ 5-–º–∏–Ω—É—Ç–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º, Swift - –Ω–µ—Ç!

---

### 7. –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**JS (lines 79-87)**:
```javascript
return {
    delta: Math.round( last_delta * 100 ) / 100
    , glucose: Math.round( now.glucose * 100 ) / 100
    , noise: Math.round(now.noise)
    , short_avgdelta: Math.round( short_avgdelta * 100 ) / 100
    , long_avgdelta: Math.round( long_avgdelta * 100 ) / 100
    , date: now_date
    , last_cal: last_cal
    , device: now.device
};
```

**Swift (lines 529-536)**:
```swift
return SwiftOpenAPSAlgorithms.GlucoseStatus(
    glucose: Double(currentBG),  // –ù–ï –æ–∫—Ä—É–≥–ª–µ–Ω–æ!
    delta: delta,                 // –ù–ï –æ–∫—Ä—É–≥–ª–µ–Ω–æ!
    shortAvgDelta: shortAvgDelta, // –ù–ï –æ–∫—Ä—É–≥–ª–µ–Ω–æ!
    longAvgDelta: longAvgDelta,   // –ù–ï –æ–∫—Ä—É–≥–ª–µ–Ω–æ!
    date: currentDate,
    noise: current.noise
)
```

**–ü–†–û–ë–õ–ï–ú–ê**: ‚ùå Swift –ù–ï –æ–∫—Ä—É–≥–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!

---

### 8. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –ø–æ–ª—è

**JS –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- delta ‚úÖ
- glucose ‚úÖ
- noise ‚úÖ
- short_avgdelta ‚úÖ
- long_avgdelta ‚úÖ
- date ‚úÖ
- last_cal ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ –≤ Swift
- device ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ –≤ Swift

**–ü–†–û–ë–õ–ï–ú–ê**: ‚ö†Ô∏è Swift –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç last_cal –∏ device!

---

## üìä –û–¶–ï–ù–ö–ê –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø

| –ö—Ä–∏—Ç–µ—Ä–∏–π | JS | Swift | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ |
|----------|-----|-------|--------------|
| –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (2.5, 7.5, 17.5, 42.5 –º–∏–Ω) | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –±–ª–∏–∑–∫–∏—Ö —Ç–æ—á–µ–∫ (2.5 –º–∏–Ω) | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ device | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| Calibration records | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ glucose > 38 | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è delta –∫ 5 –º–∏–Ω | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| –ü–æ–ª–µ last_cal | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| –ü–æ–ª–µ device | ‚úÖ | ‚ùå | üî¥ –ù–ï–¢ |
| –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç delta | ‚úÖ | ‚úÖ | ‚úÖ –î–ê |
| –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç shortAvgDelta | ‚úÖ | ‚úÖ | ‚úÖ –î–ê |
| –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç longAvgDelta | ‚úÖ | ‚úÖ | ‚úÖ –î–ê |

**–ò–¢–û–ì–û**: 3/12 (25%) - **–û–ß–ï–ù–¨ –ü–õ–û–•–û!** üî¥

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. üî¥ –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
**JS**: —Ç–æ—á–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞ –Ω—É–∂–Ω—ã–µ –º–∏–Ω—É—Ç—ã  
**Swift**: –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–æ—á–∫–∏

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –ù–µ—Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç delta –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω–æ!

### 2. üî¥ –ù–ï–¢ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è –±–ª–∏–∑–∫–∏—Ö —Ç–æ—á–µ–∫
**JS**: —É—Å—Ä–µ–¥–Ω—è–µ—Ç —Ç–æ—á–∫–∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 2.5 –º–∏–Ω—É—Ç  
**Swift**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –ë–æ–ª—å—à–µ —à—É–º–∞ –≤ –¥–∞–Ω–Ω—ã—Ö!

### 3. üî¥ –ù–ï–¢ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ delta –∫ 5-–º–∏–Ω—É—Ç–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º
**JS**: `avgdelta = change/minutesago * 5`  
**Swift**: –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–Ω–∏—Ü–∞ –∑–Ω–∞—á–µ–Ω–∏–π

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± delta! –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞!

### 4. üî¥ –ù–ï–¢ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ device
**JS**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —Å —Ç–æ–≥–æ –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞  
**Swift**: –º–æ–∂–µ—Ç —Å–º–µ—à–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ delta –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏!

### 5. üî¥ –ù–ï–¢ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
**JS**: –æ–∫—Ä—É–≥–ª—è–µ—Ç –≤—Å–µ –¥–æ 2 –∑–Ω–∞–∫–æ–≤  
**Swift**: –ø–æ–ª–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!

---

## üéØ –ß–¢–û –¢–†–ï–ë–£–ï–¢–°–Ø –ò–°–ü–†–ê–í–ò–¢–¨

### –ö—Ä–∏—Ç–∏—á–Ω–æ:
1. üî¥ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ (2.5, 7.5, 17.5, 42.5 –º–∏–Ω)
2. üî¥ –î–æ–±–∞–≤–∏—Ç—å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –±–ª–∏–∑–∫–∏—Ö —Ç–æ—á–µ–∫ (< 2.5 –º–∏–Ω)
3. üî¥ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é delta: `change/minutesago * 5`
4. ÔøΩÔøΩ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ device
5. üî¥ –î–æ–±–∞–≤–∏—Ç—å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –í–∞–∂–Ω–æ:
6. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É calibration records
7. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É glucose > 38
8. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è last_cal –∏ device –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## üìù –í–ï–†–î–ò–ö–¢

**–°—Ç–∞—Ç—É—Å**: üî¥ **–ù–ï –ì–û–¢–û–í–û!**

**Swift —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**:
- ‚úÖ –ï—Å—Ç—å –±–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ delta
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤—Å—è –ª–æ–≥–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫ 5-–º–∏–Ω—É—Ç–∞–º
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ device
- ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ

**–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**: 25% (–û–ß–ï–ù–¨ –ü–õ–û–•–û!)

**–¢–†–ï–ë–£–Æ–¢–°–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø!**

---

## üîç –ü–†–ò–ú–ï–† –†–ê–ó–õ–ò–ß–ò–ô

### JS —Ä–∞—Å—á–µ—Ç –¥–ª—è —Ç–æ—á–∫–∏ 6 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥:
```javascript
minutesago = 6
change = current - then  // –Ω–∞–ø—Ä–∏–º–µ—Ä, 10 mg/dL
avgdelta = change/minutesago * 5 = 10/6 * 5 = 8.33 mg/dL/5m
```

### Swift —Ä–∞—Å—á–µ—Ç:
```swift
delta = current - prev1  // –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–Ω–∏—Ü–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä 10 mg/dL
// –ù–ï–¢ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∫ 5 –º–∏–Ω—É—Ç–∞–º!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: Swift delta –º–æ–∂–µ—Ç –±—ã—Ç—å –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ú –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–µ 5 –º–∏–Ω—É—Ç!
