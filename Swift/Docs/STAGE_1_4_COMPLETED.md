# ‚úÖ –≠–¢–ê–ü 1.4 –ó–ê–í–ï–†–®–ï–ù: BGI, deviation, ISF, targetBG

**–î–∞—Ç–∞**: 2025-10-07 09:30  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ 100% –∑–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üéØ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ DetermineBasalResult

```swift
struct DetermineBasalResult {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    
    // ‚úÖ –ù–û–í–´–ï –ü–û–õ–Ø –∏–∑ determine-basal.js (—Å—Ç—Ä–æ–∫–∞ 806-810)
    let BGI: Double?  // Blood Glucose Impact (—Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ)
    let deviation: Double?  // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ (—Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ)
    let ISF: Double?  // Insulin Sensitivity Factor (—Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ)
    let targetBG: Double?  // –¶–µ–ª–µ–≤–æ–π BG (—Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ)
}
```

### 2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω rawJSON –¥–ª—è –≤—ã–≤–æ–¥–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π

```swift
// –í rawJSON –¥–æ–±–∞–≤–ª–µ–Ω—ã:
"BGI": \(BGIString),
"deviation": \(deviationString),
"ISF": \(ISFString),
"target_bg": \(targetBGString),
```

**–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è**: –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `convertBG` –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å `profile.outUnits`.

### 3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö

**`makeBasalDecisionWithPredictions`** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `bgi: Double`
- `deviation: Double`
- `targetBGForOutput: Double`

**`createResultWithPredictions`** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `bgi: Double`
- `deviation: Double`
- `sensitivity: Double`
- `targetBGForOutput: Double`

**–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏**:
```swift
let convertedBGI = SwiftOpenAPSAlgorithms.convertBG(bgi, profile: profile)
let convertedDeviation = SwiftOpenAPSAlgorithms.convertBG(deviation, profile: profile)
let convertedISF = SwiftOpenAPSAlgorithms.convertBG(sensitivity, profile: profile)
let convertedTargetBG = SwiftOpenAPSAlgorithms.convertBG(targetBGForOutput, profile: profile)
```

### 4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –í–°–ï –≤—ã–∑–æ–≤—ã DetermineBasalResult

**–í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ**: 13 –≤—ã–∑–æ–≤–æ–≤

**Safety —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** (11 –≤—ã–∑–æ–≤–æ–≤ —Å `nil` –∑–Ω–∞—á–µ–Ω–∏—è–º–∏):
1. ‚úÖ Error: could not get current basal rate
2. ‚úÖ Error: could not determine target_bg
3. ‚úÖ Replacing high temp basal (safety)
4. ‚úÖ Shortening long zero temp
5. ‚úÖ Temp <= current basal; doing nothing
6. ‚úÖ –ù–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ temp basal
7. ‚úÖ Error: iob_data missing
8. ‚úÖ Error: could not calculate eventualBG
9. ‚úÖ Temp mismatch warning
10. ‚úÖ Temp expired warning
11. ‚úÖ Microbolusing (simplified)

**–ü–æ–ª–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** (2 –≤—ã–∑–æ–≤–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏):
12. ‚úÖ In range: setting current basal
13. ‚úÖ Adjustment needed

**–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**:
14. ‚úÖ `createNoChangeResult` - –¥–æ–±–∞–≤–ª–µ–Ω—ã nil –∑–Ω–∞—á–µ–Ω–∏—è
15. ‚úÖ `createTempBasalResult` - –¥–æ–±–∞–≤–ª–µ–Ω—ã nil –∑–Ω–∞—á–µ–Ω–∏—è
16. ‚úÖ `createSafetyResult` - –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä profile –∏ nil –∑–Ω–∞—á–µ–Ω–∏—è

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ–π –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É**: 4 (BGI, deviation, ISF, targetBG)
- **–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ—É–Ω–∫—Ü–∏–π**: 3 (makeBasalDecisionWithPredictions, createResultWithPredictions, createSafetyResult)
- **–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤—ã–∑–æ–≤–æ–≤ DetermineBasalResult**: 13
- **–û–±–Ω–æ–≤–ª–µ–Ω–æ –≤—ã–∑–æ–≤–æ–≤ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π**: 3
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–æ**: ~150

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã

### –í—Å–µ BG-–∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è:

1. ‚úÖ `bg` - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ rawJSON
2. ‚úÖ `eventualBG` - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ rawJSON
3. ‚úÖ `predBGs` –º–∞—Å—Å–∏–≤—ã (IOB, COB, UAM, ZT) - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è
4. ‚úÖ `BGI` - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è (–Ω–æ–≤–æ–µ –ø–æ–ª–µ)
5. ‚úÖ `deviation` - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è (–Ω–æ–≤–æ–µ –ø–æ–ª–µ)
6. ‚úÖ `ISF` - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è (–Ω–æ–≤–æ–µ –ø–æ–ª–µ)
7. ‚úÖ `targetBG` - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è (–Ω–æ–≤–æ–µ –ø–æ–ª–µ)

### JSON Output –¥–ª—è mmol/L –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

```json
{
  "temp": "absolute",
  "bg": 6.7,  // –±—ã–ª–æ 120 mg/dL
  "eventualBG": 5.6,  // –±—ã–ª–æ 100 mg/dL
  "BGI": -0.3,  // —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
  "deviation": 0.2,  // —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
  "ISF": 3.3,  // –±—ã–ª–æ 60 mg/dL
  "target_bg": 5.6,  // –±—ã–ª–æ 100 mg/dL
  "predBGs": {
    "IOB": [6.7, 6.5, 6.3, ...],  // –≤—Å–µ –≤ mmol/L
    "COB": [6.7, 6.8, 6.9, ...],  // –≤—Å–µ –≤ mmol/L
    "UAM": [6.7, 6.6, 6.5, ...],  // –≤—Å–µ –≤ mmol/L
    "ZT": [6.7, 6.7, 6.7, ...]    // –≤—Å–µ –≤ mmol/L
  }
}
```

---

## üéâ –≠–¢–ê–ü 1 –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù

### –ß–µ–∫–ª–∏—Å—Ç –≠—Ç–∞–ø–∞ 1:

- [x] **–®–∞–≥ 1.1**: –î–æ–±–∞–≤–∏—Ç—å `outUnits` –≤ ProfileResult ‚úÖ
- [x] **–®–∞–≥ 1.2**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `convertBG` ‚úÖ
- [x] **–®–∞–≥ 1.3**: –î–æ–±–∞–≤–∏—Ç—å `profile` –≤ DetermineBasalResult ‚úÖ
- [x] **–®–∞–≥ 1.4**: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ BG-–∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö ‚úÖ
  - [x] `bg` –∏ `eventualBG` –≤ rawJSON ‚úÖ
  - [x] `predBGs` –º–∞—Å—Å–∏–≤—ã ‚úÖ
  - [x] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è BGI, deviation, ISF, targetBG ‚úÖ
  - [x] –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è ‚úÖ
  - [x] –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –≤—ã–∑–æ–≤—ã ‚úÖ

---

## üìà –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—Ä—Ç–∞—Ü–∏–∏

| –≠—Ç–∞–ø | –î–æ | –ü–æ—Å–ª–µ | –ü—Ä–æ–≥—Ä–µ—Å—Å |
|------|-----|-------|----------|
| –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ | 90% | **100%** | ‚úÖ –ó–ê–í–ï–†–®–ï–ù |
| –≠—Ç–∞–ø 2: Determine-basal | 40% | 40% | üü° –í –ø—Ä–æ—Ü–µ—Å—Å–µ |
| –≠—Ç–∞–ø 3: IOB | 80% | 80% | ‚ö†Ô∏è –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ |
| –≠—Ç–∞–ø 4: Profile | 70% | 70% | ‚ö†Ô∏è –ù—É–∂–Ω—ã –¥–æ—Ä–∞–±–æ—Ç–∫–∏ |
| –≠—Ç–∞–ø 5: Meal/COB | 30% | 30% | ‚è≥ –ù–∞—á–∞—Ç–æ |
| –≠—Ç–∞–ø 6: Autosens | 20% | 20% | ‚è≥ –ù–∞—á–∞—Ç–æ |
| –≠—Ç–∞–ø 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 10% | 10% | ‚è≥ –ù–∞—á–∞—Ç–æ |
| **–û–ë–©–ò–ô –ü–†–û–ì–†–ï–°–°** | **45%** | **50%** | üü° |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –≠—Ç–∞–ø 2

**–°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞**: –ü–æ—Ä—Ç–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ `enable_smb()` –∏–∑ determine-basal.js:51-125

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏**: 4 —á–∞—Å–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –¥–ª—è –≠—Ç–∞–ø–∞ 1 (–≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã)

1. ‚úÖ –§—É–Ω–∫—Ü–∏—è `convertBG` —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è mg/dL –∏ mmol/L
2. ‚úÖ –í—Å–µ BG-–∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
3. ‚úÖ `predBGs` –º–∞—Å—Å–∏–≤—ã –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
4. ‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—è BGI, deviation, ISF, targetBG –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
5. ‚úÖ –í—Å–µ –≤—ã–∑–æ–≤—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
6. ‚úÖ –ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

---

## üìù –ì–æ—Ç–æ–≤–æ –∫ –∫–æ–º–º–∏—Ç—É

**–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞**: `feat: Add BGI, deviation, ISF, targetBG fields with unit conversion`

**–û–ø–∏—Å–∞–Ω–∏–µ**:
```
–ó–∞–≤–µ—Ä—à–µ–Ω –≠—Ç–∞–ø 1.4: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è BGI, deviation, ISF, targetBG –≤ DetermineBasalResult

1. –î–æ–±–∞–≤–ª–µ–Ω—ã 4 –Ω–æ–≤—ã—Ö optional –ø–æ–ª—è –≤ DetermineBasalResult
2. –í—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ convertBG —Å–æ–≥–ª–∞—Å–Ω–æ profile.outUnits
3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ 13 –≤—ã–∑–æ–≤–æ–≤ DetermineBasalResult (11 —Å nil, 2 —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏)
4. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
5. JSON output —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç BGI, deviation, ISF, target_bg

–≠—Ç–∞–ø 1 (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫) –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù (100%).
–ü–æ—Ä—Ç–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç mmol/L –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

Refs: PORTING_PLAN.md, STAGE_1_4_COMPLETED.md
```

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~45 –º–∏–Ω—É—Ç  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–î–∞—Ç–∞**: 2025-10-07
